# Tech Stack: Database

PostgreSQL with Drizzle ORM for type-safe database access and migrations.

## PostgreSQL

| Property  | Value                      |
|-----------|----------------------------|
| Version   | 18.x                       |
| Container | `postgres:18.1-bookworm`   |
| Port      | 5432                       |

PostgreSQL is the primary datastore. Run locally via Docker Compose for development.

## Drizzle ORM

| Package      | Version  | Purpose                      |
|--------------|----------|------------------------------|
| `drizzle-orm`| ^0.45.x  | Query builder, schema types  |
| `drizzle-kit`| ^0.31.x  | Migrations CLI, Studio       |
| `postgres`   | ^3.4.x   | PostgreSQL client driver     |

### Schema Organization

Database schemas live in `src/lib/db/schema/`, one file per domain:

```
src/lib/db/schema/
├── boards.ts          # Boards table
├── columns.ts         # Columns table (belongs to board)
├── cards.ts           # Cards table (belongs to column)
├── labels.ts          # Labels table (belongs to board)
├── card-labels.ts     # Card ↔ Label junction table
├── comments.ts        # Comments table (belongs to card)
├── activity-log.ts    # Activity log entries
├── users.ts           # Users table
└── index.ts           # Barrel export for all tables and relations
```

### Schema Conventions

Use Drizzle's `pgTable` with explicit column types:

```typescript
import { pgTable, text, timestamp, integer, uuid } from "drizzle-orm/pg-core";

export const boards = pgTable("boards", {
  id: uuid("id").defaultRandom().primaryKey(),
  name: text("name").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
});
```

### Migrations

Migrations are generated by Drizzle Kit and stored in `drizzle/`:

```bash
deno task db:generate    # Generate migration from schema diff
deno task db:migrate     # Apply pending migrations
deno task db:push        # Push schema directly (dev only)
deno task db:studio      # Open Drizzle Studio browser UI
deno task db:seed         # Seed database with sample data (dev only)
```

### Configuration

`drizzle.config.ts` at the project root:

```typescript
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/lib/db/schema/*",
  out: "./drizzle",
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

### Database Connection

Single connection module in `src/lib/db/index.ts`. Uses SvelteKit's `$env/static/private` instead of `process.env` to ensure the database URL is validated at build time and never exposed to client-side code:

```typescript
import { drizzle } from "drizzle-orm/postgres-js";
import postgres from "postgres";
import { DATABASE_URL } from "$env/static/private";
import * as schema from "./schema";

const client = postgres(DATABASE_URL);
export const db = drizzle(client, { schema });
```

> **Note:** `drizzle.config.ts` still uses `process.env.DATABASE_URL!` because it runs via the `drizzle-kit` CLI outside SvelteKit.

### Query Patterns

Use Drizzle's query builder for type-safe queries:

```typescript
// Select
const boards = await db.select().from(schema.boards);

// Insert
const [board] = await db.insert(schema.boards)
  .values({ name: "My Board" })
  .returning();

// Update
await db.update(schema.boards)
  .set({ name: "Renamed" })
  .where(eq(schema.boards.id, boardId));

// Delete
await db.delete(schema.boards)
  .where(eq(schema.boards.id, boardId));

// Relations
const boardWithColumns = await db.query.boards.findFirst({
  where: eq(schema.boards.id, boardId),
  with: { columns: { with: { cards: true } } },
});
```

## Seeding

`scripts/seed.ts` populates the database with sample data for local development. Requires `DATABASE_URL` env var. Safe to run multiple times — truncates all tables first.

```bash
deno task db:seed
# or: DATABASE_URL=postgresql://kanban:kanban@localhost:5432/kanban deno run -A scripts/seed.ts
```

Creates: 3 users, 1 board with 5 columns, 5 labels, 9 cards (spread across columns with labels, assignees, and due dates), 5 comments, and 5 activity log entries.

## Environment Variables

| Variable       | Description                    | Example                                    |
|----------------|--------------------------------|--------------------------------------------|
| `DATABASE_URL` | PostgreSQL connection string   | `postgresql://user:pass@localhost:5432/kanban` |
| `POSTGRES_USER`| Docker Compose DB user         | `kanban`                                   |
| `POSTGRES_PASSWORD` | Docker Compose DB password | `kanban`                                   |
| `POSTGRES_DB`  | Docker Compose DB name         | `kanban`                                   |
